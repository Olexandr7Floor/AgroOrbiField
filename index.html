<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgroVerse — Симулятор Ферми NASA POWER</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  
  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  
  <!-- Google Fonts (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* CSS Styles (Dark Theme from main.css) */
    :root {
        --primary: #2b8cbe; /* Blue */
        --primary-dark: #1a6a9c;
        --secondary: #cbe22b; /* Lime Green */
        --secondary-light: #b6f7c6;
        --bg-dark: #0f1720;
        --bg-card: rgba(13, 25, 43, 0.9); /* Semi-transparent dark card */
        --bg-card-light: rgba(255, 255, 255, 0.05);
        --text-primary: #e6eef6;
        --text-secondary: #9aa8b2;
        --text-muted: #6b7a85;
        --border: rgba(255, 255, 255, 0.08);
        --success: #4CAF50;
        --warning: #FF9800;
        --danger: #f44336;
        --shadow: 0 8px 32px rgba(2, 6, 23, 0.4);
        --radius: 12px;
        --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body, #app {
        height: 100%;
        margin: 0;
        font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
        /* Dark blue gradient background */
        background: linear-gradient(135deg, #071025 0%, #0f1720 100%);
        color: var(--text-primary);
        overflow: hidden;
    }

    #app {
        display: flex;
        flex-direction: column;
    }

    .container {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 24px;
        padding: 24px;
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        flex-grow: 1;
        overflow: hidden;
    }
    
    .card {
        background: var(--bg-card);
        backdrop-filter: blur(8px);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }

    #map {
        height: 100%;
        min-height: 400px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        z-index: 10;
        overflow: hidden;
    }
    
    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-height: calc(100vh - 48px);
        overflow-y: auto;
    }
    
    /* Header & Title */
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    
    .app-title {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      /* Gradient text effect */
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .app-subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin-top: 4px;
    }
    
    .game-button {
        display: flex;
        align-items: center;
        gap: 6px;
        background-color: var(--bg-card-light); 
        color: var(--secondary);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 14px;
        text-decoration: none;
        border: 1px solid var(--border);
        transition: var(--transition);
    }
    .game-button:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: var(--secondary-light);
    }
    
    /* Form Elements */
    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--text-secondary);
    }

    .form-group input[type=range] {
        width: 100%;
        -webkit-appearance: none;
        appearance: none;
        height: 8px;
        background: var(--bg-card-light);
        border-radius: 4px;
        margin-top: 5px;
        transition: var(--transition);
    }
    .form-group input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
        border: 3px solid var(--text-primary);
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
        transition: var(--transition);
    }
    .form-group input[type=range]::-webkit-slider-thumb:hover {
        background: var(--primary-dark);
    }
    
    .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background-color: var(--bg-card-light);
        color: var(--text-primary);
        appearance: none;
        background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%239aa8b2"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        cursor: pointer;
    }
    
    .range-value {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        margin-top: 4px;
        color: var(--text-muted);
    }
    
    /* Buttons */
    .btn-group {
        display: flex;
        gap: 12px;
        margin-top: 10px;
    }
    .btn {
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: var(--primary);
        border: none;
        padding: 12px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s, transform 0.1s, box-shadow 0.3s;
    }
    .btn:hover {
        background: var(--primary-dark);
        box-shadow: 0 4px 15px rgba(43, 140, 190, 0.4);
    }
    .btn-ghost {
        background: var(--bg-card-light);
        border: 1px solid var(--border);
        color: var(--text-primary);
    }
    .btn-ghost:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--primary);
    }
    .btn:active {
        transform: translateY(1px);
    }

    /* Data Grid & Results */
    .data-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 24px;
        height: 100%;
        min-height: 250px;
    }
    .data-panel {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .coords {
        color: var(--secondary);
        font-weight: 600;
        font-size: 14px;
    }
    .data-summary-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        border-bottom: 1px dashed var(--border);
        padding-bottom: 4px;
    }
    .data-summary-content {
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    .card-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
    }
    .card-subtitle {
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 4px;
    }

    .results-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 15px;
    }
    .result-item {
        padding: 12px;
        background: rgba(43, 140, 190, 0.1);
        border: 1px solid var(--border);
        border-radius: 8px;
    }
    .result-label {
        font-size: 12px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .result-value {
        font-size: 24px;
        font-weight: 700;
        margin-top: 4px;
        color: var(--text-primary);
    }
    .result-value.score {
        background: linear-gradient(45deg, var(--secondary), var(--success));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 28px;
    }
    
    /* Log */
    .log-container {
        margin-top: 20px;
        min-height: 120px;
    }
    .log {
        background-color: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px;
        max-height: 150px;
        overflow-y: auto;
        font-size: 12px;
    }
    .log-entry {
        padding: 4px 0;
        border-bottom: 1px dashed rgba(255, 255, 255, 0.05);
        color: var(--text-secondary);
    }
    .log-time {
        font-weight: 500;
        color: var(--primary);
    }
    
    /* Errors */
    #errors {
        display: none;
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: var(--danger);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }

    /* Footer */
    footer {
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
      padding: 12px 0;
      border-top: 1px solid var(--border);
    }
    
    /* Map Marker Popup Styling */
    .leaflet-popup-content-wrapper, .leaflet-popup-tip {
        background: var(--bg-card) !important;
        color: var(--text-primary) !important;
        box-shadow: var(--shadow);
    }
    .leaflet-popup-content {
        padding: 10px !important;
    }

    /* Leaflet Draw Customization */
    .leaflet-draw-toolbar a {
        background-color: var(--bg-card) !important;
        border-radius: 8px;
        color: var(--text-primary) !important;
        border: 1px solid var(--border);
    }
    .leaflet-draw-actions a {
        background-color: var(--primary) !important;
        color: white !important;
    }
    .leaflet-draw-actions a:hover {
        background-color: var(--primary-dark) !important;
    }

    /* Loader */
    #loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2000;
        background-color: var(--bg-card);
        padding: 2rem 3rem;
        border-radius: 1rem;
        box-shadow: var(--shadow);
        text-align: center;
        display: none;
        border: 1px solid var(--border);
    }
    .spinner {
        border: 6px solid var(--bg-card-light);
        border-top: 6px solid var(--primary);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Tutorial */
    .tutorial-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 3000;
        display: none;
        align-items: center;
        justify-content: center;
    }
    .tutorial-card {
        background: var(--bg-card);
        border-radius: var(--radius);
        padding: 30px;
        max-width: 500px;
        margin: 20px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }
    .tutorial-step {
        display: none;
    }
    .tutorial-step.active {
        display: block;
    }
    .tutorial-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }
    .tutorial-indicators {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 15px 0;
    }
    .tutorial-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-muted);
        cursor: pointer;
    }
    .tutorial-indicator.active {
        background: var(--primary);
    }

    /* Notification */
    .custom-notification {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--warning);
        color: #333;
        padding: 10px 20px;
        border-radius: 8px;
        z-index: 1001;
        box-shadow: var(--shadow);
        font-size: 14px;
        font-weight: 500;
    }

    /* Responsive design */
    @media (max-width: 1100px) {
        .container {
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
            gap: 16px;
            padding: 16px;
        }
        
        .sidebar {
            order: 2;
            height: auto;
            max-height: 50vh;
        }
        
        .data-grid {
            grid-template-columns: 1fr;
        }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Tutorial Overlay -->
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-card">
            <div class="tutorial-step active" id="step1-tutorial">
                <h3 class="card-title mb-4">Ласкаво просимо до AgroVerse! 🚀</h3>
                <p class="text-sm text-gray-300 mb-4">Цей посібник допоможе вам навчитися користуватися нашим симулятором ферми з даними NASA.</p>
                <p class="text-sm text-gray-400">Натисніть "Далі" щоб продовжити.</p>
            </div>
            
            <div class="tutorial-step" id="step2-tutorial">
                <h3 class="card-title mb-4">Крок 1: Оберіть дату</h3>
                <p class="text-sm text-gray-300 mb-4">Виберіть дату для аналізу. Деякі дані оновлюються раз на 8 днів.</p>
                <p class="text-sm text-gray-400">Для кращих результатів обирайте дати на 1-8 днів раніше.</p>
            </div>
            
            <div class="tutorial-step" id="step3-tutorial">
                <h3 class="card-title mb-4">Крок 2: Намалюйте ферму</h3>
                <p class="text-sm text-gray-300 mb-4">Використовуйте інструмент "Полігон" на карті, щоб окреслити вашу ділянку.</p>
                <p class="text-sm text-gray-400">Клацайте на карті, щоб створити кути полігону, та двічі клацніть для завершення.</p>
            </div>
            
            <div class="tutorial-step" id="step4-tutorial">
                <h3 class="card-title mb-4">Крок 3: Налаштуйте параметри</h3>
                <p class="text-sm text-gray-300 mb-4">Оберіть культуру, встановіть полив та добрива для симуляції.</p>
                <p class="text-sm text-gray-400">Балансуйте між врожайністю та екологічністю.</p>
            </div>
            
            <div class="tutorial-step" id="step5-tutorial">
                <h3 class="card-title mb-4">Крок 4: Запустіть симуляцію</h3>
                <p class="text-sm text-gray-300 mb-4">Натисніть "Запустити симуляцію" для отримання результатів.</p>
                <p class="text-sm text-gray-400">Система проаналізує дані NASA та надасть рекомендації.</p>
            </div>
            
            <div class="tutorial-indicators">
                <div class="tutorial-indicator active" data-step="1"></div>
                <div class="tutorial-indicator" data-step="2"></div>
                <div class="tutorial-indicator" data-step="3"></div>
                <div class="tutorial-indicator" data-step="4"></div>
                <div class="tutorial-indicator" data-step="5"></div>
            </div>
            
            <div class="tutorial-navigation">
                <button class="btn btn-ghost" id="prevTutorial">Назад</button>
                <button class="btn" id="nextTutorial">Далі</button>
                <button class="btn" id="skipTutorial" style="display: none;">Пропустити</button>
            </div>
        </div>
    </div>

    <div class="container">
      
      <!-- Left Sidebar - Controls -->
      <div class="card sidebar">
        <div class="header-container">
          <div>
            <h1 class="app-title">AgroVerse</h1>
            <div class="app-subtitle">Farm Navigators — Місія GIS</div>
          </div>
          <div class="flex gap-2">
            <button class="game-button" id="showTutorial" title="Показати інструкцію">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" fill="currentColor"/>
              </svg>
              Допомога
            </button>
            <a href="#" class="game-button" title="Game feature is under development">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
              </svg>
              Game (MVP)
            </a>
          </div>
        </div>

        <!-- Date Selection -->
        <div class="form-group">
          <label for="date-picker">Крок 1: Оберіть дату аналізу</label>
          <input type="date" id="date-picker" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-800 text-white">
          <div class="text-xs text-gray-400 mt-1">Деякі дані оновлюються раз на 8 днів</div>
        </div>
        
        <div class="data-panel">
            <div class="data-summary-title">Обрана ділянка</div>
            <div id="coords" class="coords">Намалюйте полігон на карті</div>
            <div id="dataSummary" class="data-summary-content">
                Використовуйте інструмент "Полігон" на карті, щоб окреслити вашу зону інтересу.
            </div>
        </div>

        <div class="form-group">
          <label for="cropSelect">Крок 2: Оберіть культуру</label>
          <select id="cropSelect">
            <option value="maize">Кукурудза</option>
            <option value="wheat">Пшениця</option>
            <option value="soy">Соя</option>
            <option value="sorghum">Сорго</option>
          </select>
        </div>

        <div class="form-group">
          <label for="irrigation">Полив (мм / день)</label>
          <input id="irrigation" type="range" min="0" max="10" step="0.5" value="3">
          <div class="range-value">
            <span>Інтенсивність поливу</span>
            <span id="irrigationOut">3.0</span>
          </div>
        </div>

        <div class="form-group">
          <label for="fert">Добрива (кг / га)</label>
          <input id="fert" type="range" min="0" max="200" step="10" value="80">
          <div class="range-value">
            <span>Внесено добрив (N)</span>
            <span id="fertOut">80</span>
          </div>
        </div>

        <!-- Action Button -->
        <div class="btn-group">
          <button id="runSim" class="btn" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
            </svg>
            Запустити симуляцію (1 рік)
          </button>
          <button class="btn btn-ghost" id="reset">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4.01 7.58 4.01 12C4.01 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z" fill="currentColor"/>
            </svg>
            Скинути
          </button>
        </div>

        <div class="mt-4 p-4 bg-blue-900 border-l-4 border-blue-400 text-blue-200 text-sm rounded">
          <p><strong>Примітка:</strong> Деякі дані (NDVI, температура) оновлюються раз на 8 днів. Якщо шар не відображається, спробуйте обрати дату на 1-8 днів раніше.</p>
        </div>
        
        <div class="log-container">
            <label>Журнал активності</label>
            <div class="log" id="log">
                <div class="log-entry">
                    <span class="log-time">[Init]</span> Система готова. Оберіть дату та намалюйте ділянку на карті.
                </div>
            </div>
        </div>
      </div>

      <!-- Right Panel - Map and Data Grid -->
      <div class="flex-grow flex flex-col gap-6">
        <div style="flex-grow: 1; position: relative;">
          <!-- Map container -->
          <div id="map"></div>
          
          <!-- Loader -->
          <div id="loader">
            <div class="spinner"></div>
            <p class="text-lg font-semibold text-gray-300">Обробка запиту до NASA...</p>
            <p class="text-sm text-gray-400">Завантажуємо супутникові дані.</p>
          </div>

          <!-- Errors Notification -->
          <div id="errors"></div>
        </div>

        <!-- Data Grid -->
        <div class="data-grid">
          <div class="card data-card">
            <div class="card-header">
              <h3 class="card-title">Прогноз погоди / Дані NASA POWER</h3>
              <div class="card-subtitle">Отримано метеорологічні дані для симуляції.</div>
            </div>
            <div id="powerDataSummary" style="margin-top: 15px;">Намалюйте ділянку та оберіть дату для перегляду даних.</div>
          </div>

          <div class="card data-card">
            <div class="card-header">
              <h3 class="card-title">Підсумок сезону</h3>
              <div class="card-subtitle">Оцінка екологічності та ефективності</div>
            </div>
            <div class="results-grid">
              <div class="result-item">
                <div class="result-label">Врожай (кг/га)</div>
                <div class="result-value" id="yieldVal">—</div>
              </div>
              <div class="result-item">
                <div class="result-label">Використання води (м³)</div>
                <div class="result-value" id="waterVal">—</div>
              </div>
              <div class="result-item">
                <div class="result-label">Викиди / екологія</div>
                <div class="result-value" id="ecoVal">—</div>
              </div>
              <div class="result-item">
                <div class="result-label">Оцінка</div>
                <div class="result-value score" id="scoreVal">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer>Прототип — використано NASA POWER API & GIBS. У повній версії будуть інші сервіси.</footer>
  </div>

  <!-- Leaflet & GIS Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Leaflet Draw -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <!-- Turf.js для геооперацій -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    // --- ГЛОБАЛЬНІ ЗМІННІ ---
    let map;
    let drawnLayer = null;
    let mapLayers = {};
    let layerControl = null;
    let drawnItems = null;
    let drawControl = null;
    
    const errorsEl = document.getElementById('errors');
    const runSimBtn = document.getElementById('runSim');
    const coordsEl = document.getElementById('coords');
    const powerDataSummaryEl = document.getElementById('powerDataSummary');
    const datePicker = document.getElementById('date-picker');
    const loader = document.getElementById('loader');
    
    // Tutorial variables
    let currentTutorialStep = 1;
    const totalTutorialSteps = 5;

    // --- ДОПОМІЖНІ ФУНКЦІЇ ---
    
    // Функція для відображення помилок
    function showError(msg) {
      console.error(msg);
      errorsEl.textContent = msg;
      errorsEl.style.display = 'block';
      setTimeout(() => {
        errorsEl.style.display = 'none';
      }, 5000);
    }
    
    // Функція для додавання повідомлень у лог
    function log(text) {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      const time = new Date().toLocaleTimeString('uk-UA');
      entry.innerHTML = `<span class="log-time">[${time}]</span> ${text}`;
      logEl.prepend(entry);
      
      // Обмеження кількості записів у лозі до 10
      if (logEl.children.length > 10) {
        logEl.removeChild(logEl.lastChild);
      }
    }
    
    // Оновлення значень поливу
    function updateIrrigationValue(e) {
      document.getElementById('irrigationOut').textContent = e.target.value;
      log(`Значення поливу змінено на: ${e.target.value} мм/день`);
    }

    // Оновлення значень добрив
    function updateFertilizerValue(e) {
      document.getElementById('fertOut').textContent = e.target.value;
      log(`Значення добрив змінено на: ${e.target.value} кг/га`);
    }

    // Встановлення результатів симуляції
    function displaySimulationResults(results) {
      document.getElementById('yieldVal').textContent = `${results.yield} кг`;
      document.getElementById('waterVal').textContent = `${results.water} м³`;
      document.getElementById('ecoVal').textContent = results.eco;
      document.getElementById('scoreVal').textContent = results.score;
      log('Симуляція успішно завершена. Результати оновлено.');
    }

    // Скидання форми до початкового стану
    function resetForm() {
      document.getElementById('irrigation').value = 3;
      document.getElementById('irrigationOut').textContent = '3.0';
      document.getElementById('fert').value = 80;
      document.getElementById('fertOut').textContent = '80';
      document.getElementById('cropSelect').value = 'maize';
      coordsEl.textContent = 'Намалюйте полігон на карті';
      powerDataSummaryEl.innerHTML = 'Намалюйте ділянку та оберіть дату для перегляду даних.';
      
      // Скидання результатів
      document.getElementById('yieldVal').textContent = '—';
      document.getElementById('waterVal').textContent = '—';
      document.getElementById('ecoVal').textContent = '—';
      document.getElementById('scoreVal').textContent = '—';
      
      // Скидання карти
      if (drawnLayer) {
        drawnItems.removeLayer(drawnLayer);
        drawnLayer = null;
      }
      
      Object.values(mapLayers).forEach(layer => map.removeLayer(layer));
      mapLayers = {};
      if (layerControl) map.removeControl(layerControl);

      updateUIState();
      log('Параметри скинуто до початкових значень');
    }

    // Оновлення стану UI
    function updateUIState() {
      if (drawnLayer && datePicker.value) {
        runSimBtn.disabled = false;
      } else {
        runSimBtn.disabled = true;
      }
    }

    // Функція для відображення тимчасового сповіщення на карті
    function showErrorNotification(layerName) {
      const notification = L.DomUtil.create('div', 'custom-notification', map.getContainer());
      notification.innerHTML = `Дані для шару "${layerName}" на обрану дату відсутні. Спробуйте іншу дату.`;
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 5000);
    }

    function getSelectedDate() {
      return datePicker.value;
    }

    // --- ЛОГІКА КАРТИ ТА ПОДІЙ ---

    // Ініціалізація Leaflet карти
    function initializeMap() {
      map = L.map('map', {
        minZoom: 2,
        maxZoom: 18,
        worldCopyJump: false,
        maxBounds: [[-85, -180], [85, 180]],
        maxBoundsViscosity: 1.0
      }).setView([48.3794, 31.1656], 6); // Центр України

      // Base layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      // Draw controls
      drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      drawControl = new L.Control.Draw({
        edit: {
          featureGroup: drawnItems,
          remove: true
        },
        draw: {
          polygon: {
            allowIntersection: false,
            showArea: true
          },
          polyline: false,
          rectangle: false,
          circle: false,
          marker: false,
          circlemarker: false
        }
      });
      map.addControl(drawControl);

      // Map events for drawing
      map.on(L.Draw.Event.CREATED, (e) => {
        if (drawnLayer) drawnItems.removeLayer(drawnLayer);
        drawnLayer = e.layer;
        drawnItems.addLayer(drawnLayer);
        
        const area = L.GeometryUtil.geodesicArea(drawnLayer.getLatLngs()[0]);
        const areaHa = (area / 10000).toFixed(2);
        coordsEl.textContent = `Площа: ${areaHa} га`;
        
        updateUIState();
        log(`Намальовано ділянку площею ${areaHa} га`);
      });

      map.on(L.Draw.Event.EDITED, (e) => {
        e.layers.eachLayer((layer) => { 
          drawnLayer = layer; 
          const area = L.GeometryUtil.geodesicArea(drawnLayer.getLatLngs()[0]);
          const areaHa = (area / 10000).toFixed(2);
          coordsEl.textContent = `Площа: ${areaHa} га`;
        });
        updateUIState();
        log('Ділянку відредаговано');
      });

      map.on(L.Draw.Event.DELETED, () => {
        drawnLayer = null;
        coordsEl.textContent = 'Намалюйте полігон на карті';
        updateUIState();
        log('Ділянку видалено');
      });
    }

    // --- ЛОГІКА NASA POWER API & GIBS ---

    // Завантаження даних NASA GIBS
    function fetchNasaData() {
      if (!drawnLayer) {
        showError('Будь ласка, спочатку намалюйте ділянку на карті.');
        return;
      }
      if (!datePicker.value) {
        showError('Будь ласка, оберіть дату для аналізу.');
        return;
      }

      loader.style.display = 'flex';
      
      // Clean up previous layers
      Object.values(mapLayers).forEach(layer => map.removeLayer(layer));
      mapLayers = {};
      if (layerControl) map.removeControl(layerControl);

      const selectedDate = getSelectedDate();
      
      const nasaGibsLayers = {
        "Супутниковий знімок (True Color)": `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_CorrectedReflectance_TrueColor/default/${selectedDate}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`,
        "Індекс вегетації (NDVI)": `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_NDVI_8Day/default/${selectedDate}/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png`,
        "Вологість ґрунту (SMAP)": `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/SMAP_L3_SM_P_E_Daily/default/${selectedDate}/GoogleMapsCompatible_Level6/{z}/{y}/{x}.png`,
        "Температура поверхні (день)": `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_LST_Day_8Day/default/${selectedDate}/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png`
      };

      const baseLayers = { 
        "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        })
      };
      
      const overlayLayers = {};

      for (const [name, url] of Object.entries(nasaGibsLayers)) {
        const layer = L.tileLayer(url, {
          attribution: 'NASA GIBS',
          opacity: 0.75,
          maxNativeZoom: getLayerMaxZoom(name) 
        });

        // Add error handling for each tile layer
        layer.on('tileerror', (e) => {
          if (!layer.hasError) {
            showErrorNotification(name);
            layer.hasError = true;
          }
        });
        layer.on('load', () => { layer.hasError = false; });
        
        overlayLayers[name] = layer;
        mapLayers[name] = layer;
      }
      
      // Add first overlay layer by default
      if (Object.keys(overlayLayers).length > 0) {
        const firstLayer = Object.values(overlayLayers)[0];
        firstLayer.addTo(map);
      }

      layerControl = L.control.layers(baseLayers, overlayLayers, {collapsed: false}).addTo(map);
      map.fitBounds(drawnLayer.getBounds());
      
      // Update info panel
      const area = L.GeometryUtil.geodesicArea(drawnLayer.getLatLngs()[0]);
      const areaHa = (area / 10000).toFixed(2);
      powerDataSummaryEl.innerHTML = `
        <div class="text-sm">
          <p><strong>Площа:</strong> ${areaHa} гектарів</p>
          <p><strong>Дата аналізу:</strong> ${selectedDate}</p>
          <p class="mt-2 text-green-400">Дані NASA успішно завантажено!</p>
        </div>
      `;

      setTimeout(() => {
        loader.style.display = 'none';
        log(`Дані NASA завантажено для ділянки ${areaHa} га (${selectedDate})`);
      }, 2000);
    }

    function getLayerMaxZoom(layerName) {
      if (layerName.includes("True Color")) return 9;
      if (layerName.includes("NDVI")) return 7;
      if (layerName.includes("Температура")) return 7;
      if (layerName.includes("SMAP")) return 6;
      return 8;
    }

    // Емуляція функції, що запускає симуляцію
    function runSimulation() {
      if (!drawnLayer) {
        showError('Будь ласка, оберіть ділянку на карті, перш ніж запускати симуляцію.');
        return;
      }

      runSimBtn.disabled = true;
      runSimBtn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div> Обчислення...';
      log('Симуляція запущена...');

      // Отримання вхідних параметрів
      const crop = document.getElementById('cropSelect').value;
      const irrigation = parseFloat(document.getElementById('irrigation').value);
      const fert = parseFloat(document.getElementById('fert').value);
      
      // Емуляція затримки обчислення симуляції
      setTimeout(() => {
        // Емуляція складного алгоритму симуляції
        let yieldFactor = 4500;
        let waterFactor = 200;
        let ecoFactor = 'Середній';
        let score = 75;

        // Налаштування на основі вхідних параметрів
        if (crop === 'maize') {
          yieldFactor += irrigation * 100 + fert * 5;
          waterFactor += irrigation * 50;
        } else if (crop === 'wheat') {
          yieldFactor += irrigation * 70 + fert * 7;
          waterFactor += irrigation * 30;
        }

        // Логіка оцінки
        if (fert > 150) {
            ecoFactor = 'Низький (Надлишок добрив)';
            score -= 10;
        } else if (irrigation > 8) {
            waterFactor += 200;
            ecoFactor = 'Посередній (Високе споживання води)';
            score -= 5;
        } else {
            ecoFactor = 'Високий';
            score += 5;
        }

        const results = {
          yield: yieldFactor.toFixed(0),
          water: waterFactor.toFixed(0),
          eco: ecoFactor,
          score: Math.min(100, Math.max(50, score)).toFixed(0) + '/100'
        };

        displaySimulationResults(results);
        
        runSimBtn.disabled = false;
        runSimBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 5V19L19 12L8 5Z" fill="currentColor"/></svg> Запустити симуляцію (1 рік)';

      }, 3000);
    }

    // --- TUTORIAL FUNCTIONS ---
    function showTutorial() {
      document.getElementById('tutorialOverlay').style.display = 'flex';
      currentTutorialStep = 1;
      updateTutorialStep();
    }

    function updateTutorialStep() {
      // Hide all steps
      document.querySelectorAll('.tutorial-step').forEach(step => {
        step.classList.remove('active');
      });
      
      // Show current step
      document.getElementById(`step${currentTutorialStep}-tutorial`).classList.add('active');
      
      // Update indicators
      document.querySelectorAll('.tutorial-indicator').forEach((indicator, index) => {
        indicator.classList.toggle('active', index + 1 === currentTutorialStep);
      });
      
      // Update navigation buttons
      document.getElementById('prevTutorial').style.display = currentTutorialStep > 1 ? 'block' : 'none';
      document.getElementById('nextTutorial').style.display = currentTutorialStep < totalTutorialSteps ? 'block' : 'none';
      document.getElementById('skipTutorial').style.display = currentTutorialStep === totalTutorialSteps ? 'block' : 'none';
    }

    function nextTutorialStep() {
      if (currentTutorialStep < totalTutorialSteps) {
        currentTutorialStep++;
        updateTutorialStep();
      } else {
        closeTutorial();
      }
    }

    function prevTutorialStep() {
      if (currentTutorialStep > 1) {
        currentTutorialStep--;
        updateTutorialStep();
      }
    }

    function closeTutorial() {
      document.getElementById('tutorialOverlay').style.display = 'none';
    }

    // --- ІНІЦІАЛІЗАЦІЯ ---
    
    window.onload = function() {
      // Set default date
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(today.getDate() - 2);
      
      datePicker.value = yesterday.toISOString().split('T')[0];
      datePicker.max = today.toISOString().split('T')[0];

      initializeMap();
      setupEventListeners();
      
      // Show tutorial on first visit
      if (!localStorage.getItem('agroverseTutorialShown')) {
        setTimeout(showTutorial, 1000);
        localStorage.setItem('agroverseTutorialShown', 'true');
      }
      
      log('Система готова до роботи. Оберіть дату та намалюйте ділянку.');
    }

    function setupEventListeners() {
      const irrigationInput = document.getElementById('irrigation');
      const fertInput = document.getElementById('fert');
      const resetBtn = document.getElementById('reset');

      // Range input events
      irrigationInput.addEventListener('input', updateIrrigationValue);
      fertInput.addEventListener('input', updateFertilizerValue);

      // Action buttons
      runSimBtn.addEventListener('click', runSimulation);
      resetBtn.addEventListener('click', resetForm);
      
      // Date picker
      datePicker.addEventListener('change', updateUIState);
      
      // Tutorial events
      document.getElementById('showTutorial').addEventListener('click', showTutorial);
      document.getElementById('nextTutorial').addEventListener('click', nextTutorialStep);
      document.getElementById('prevTutorial').addEventListener('click', prevTutorialStep);
      document.getElementById('skipTutorial').addEventListener('click', closeTutorial);
      
      // Initial values display
      document.getElementById('irrigationOut').textContent = irrigationInput.value;
      document.getElementById('fertOut').textContent = fertInput.value;
    }
  </script>
</body>
</html>