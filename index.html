<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgroOrbiField — NASA POWER Farm Simulator</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@3.1.4/dist/esri-leaflet-geocoder.css" crossorigin="">


  <style>
    /* CSS Styles (Dark Theme from main.css) - NO CHANGES HERE */
    :root {
        --primary: #2b8cbe; /* Blue */
        --primary-dark: #1a6a9c;
        --secondary: #cbe22b; /* Lime Green */
        --secondary-light: #b6f7c6;
        --bg-dark: #0f1720;
        --bg-card: rgba(13, 25, 43, 0.9); /* Semi-transparent dark card */
        --bg-card-light: rgba(255, 255, 255, 0.05);
        --text-primary: #e6eef6;
        --text-secondary: #9aa8b2;
        --text-muted: #6b7a85;
        --border: rgba(255, 255, 255, 0.08);
        --success: #4CAF50;
        --warning: #FF9800;
        --danger: #f44336;
        --shadow: 0 8px 32px rgba(2, 6, 23, 0.4);
        --radius: 12px;
        --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body, #app {
        height: 100%;
        margin: 0;
        font-family: 'Inter', 'Segoe UI', Roboto, Arial, sans-serif;
        /* Dark blue gradient background */
        background: linear-gradient(135deg, #071025 0%, #0f1720 100%);
        color: var(--text-primary);
        overflow: auto; 
    }

    #app {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    .container {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 8px;
        padding: 8px;
        width: 100%;
        height: auto; 
        flex-grow: 1;
        overflow: visible;
    }
    
    .card {
        background: var(--bg-card);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        height: auto; 
        overflow-y: auto;
    }

    #map {
        min-height: 300px;
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        z-index: 10;
        overflow: hidden;
        width: 100%;
    }
    
    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
        overflow-y: auto;
    }
    
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    
    .app-title {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .app-subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin-top: 4px;
    }
    
    .game-button-footer {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        background: linear-gradient(90deg, var(--secondary), var(--secondary-light));
        color: var(--bg-dark);
        padding: 15px 20px;
        border-radius: 10px;
        font-size: 18px;
        font-weight: 700;
        text-decoration: none;
        border: none;
        box-shadow: 0 4px 20px rgba(203, 226, 43, 0.4);
        transition: var(--transition);
        width: 100%;
    }

    .game-button-footer:hover {
        background: linear-gradient(90deg, var(--secondary-light), var(--secondary));
        box-shadow: 0 6px 25px rgba(203, 226, 43, 0.6);
        transform: translateY(-2px);
    }

    .game-button-footer svg {
        fill: var(--bg-dark);
    }
    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--text-secondary);
    }

    .form-group input[type=range] {
        width: 100%;
        -webkit-appearance: none;
        appearance: none;
        height: 8px;
        background: var(--bg-card-light);
        border-radius: 4px;
        margin-top: 5px;
        transition: var(--transition);
    }
    .form-group input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
        border: 3px solid var(--text-primary);
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
        transition: var(--transition);
    }
    .form-group input[type=range]::-webkit-slider-thumb:hover {
        background: var(--primary-dark);
    }
    
    .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background-color: var(--bg-card-light);
        color: var(--text-primary);
        appearance: none;
        background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%239aa8b2"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        cursor: pointer;
    }
    
    .range-value {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        margin-top: 4px;
        color: var(--text-muted);
    }
    
    .btn-group {
        display: flex;
        gap: 12px;
        margin-top: 10px;
    }
    .btn {
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: var(--primary);
        border: none;
        padding: 12px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s, transform 0.1s, box-shadow 0.3s;
    }
    .btn:hover {
        background: var(--primary-dark);
        box-shadow: 0 4px 15px rgba(43, 140, 190, 0.4);
    }
    .btn-ghost {
        background: var(--bg-card-light);
        border: 1px solid var(--border);
        color: var(--text-primary);
    }
    .btn-ghost:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--primary);
    }
    .btn:active {
        transform: translateY(1px);
    }

    .data-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0;
        min-height: 180px; 
    }
    .data-panel {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .coords {
        color: var(--secondary);
        font-weight: 600;
        font-size: 14px;
    }
    .data-summary-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        border-bottom: 1px dashed var(--border);
        padding-bottom: 4px;
    }
    .data-summary-content {
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    .card-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
    }
    .card-subtitle {
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 4px;
    }

    .results-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 15px;
    }
    .result-item {
        padding: 12px;
        background: rgba(43, 140, 190, 0.1);
        border: 1px solid var(--border);
        border-radius: 8px;
    }
    .result-label {
        font-size: 12px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .result-value {
        font-size: 24px;
        font-weight: 700;
        margin-top: 4px;
        color: var(--text-primary);
    }
    .result-value.score {
        background: linear-gradient(45deg, var(--secondary), var(--success));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 28px;
    }

/* СТИЛІ LEAFLET CONTROL LAYERS */
.leaflet-control-layers {
    background-color: var(--bg-card) !important; 
    backdrop-filter: blur(5px);
    border: 1px solid var(--border) !important;
    border-radius: var(--radius) !important;
    box-shadow: var(--shadow);
    padding: 10px;
    color: var(--text-primary);
    font-size: 14px;
    position: relative; 
}

/* СТИЛІ ДЛЯ КНОПКИ ЗГОРТАННЯ/РОЗГОРТАННЯ ШАРІВ */
#toggleLayersButton {
    position: absolute;
    top: 5px;
    right: 5px;
    background: var(--bg-card-light);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    width: 20px;
    height: 20px;
    border-radius: 4px;
    text-align: center;
    line-height: 18px;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
    transition: var(--transition);
    z-index: 10;
}

#toggleLayersButton:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

.leaflet-control-layers-list.hidden {
    display: none;
}
/* Кінець СТИЛІВ ДЛЯ КНОПКИ ЗГОРТАННЯ/РОЗГОРТАННЯ ШАРІВ */


.leaflet-control-layers-expanded {
    padding: 10px 15px 10px 10px !important;
    white-space: nowrap;
}

.leaflet-control-layers-separator {
    margin: 8px 0;
    border-top: 1px solid var(--border) !important;
}

.leaflet-control-layers label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 2px 0;
    transition: color 0.2s;
}

.leaflet-control-layers label:hover {
    color: var(--text-primary);
}

.leaflet-control-layers input[type="radio"],
.leaflet-control-layers input[type="checkbox"] {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 1px solid var(--text-muted);
    border-radius: 3px;
    background-color: var(--bg-dark);
    transition: all 0.2s;
    margin-right: 0;
    flex-shrink: 0;
}

.leaflet-control-layers input:checked {
    background-color: var(--primary);
    border-color: var(--primary);
}

.leaflet-control-layers input[type="checkbox"]:checked::before {
    content: '✔';
    display: block;
    color: var(--text-primary);
    font-size: 10px;
    line-height: 14px;
    text-align: center;
}
    
    #errors {
        display: none;
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: var(--danger);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }

    footer {
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
      padding: 12px 0;
      border-top: 1px solid var(--border);
      position: relative;
      width: 100%;
      background: var(--bg-card);
      z-index: 50;
    }
    
    .leaflet-container {
        cursor: crosshair;
    }
    .leaflet-draw-toolbar a {
        background-color: var(--bg-card) !important;
        border-color: var(--border) !important;
        color: var(--text-primary) !important;
        opacity: 0.8;
    }
    .leaflet-draw-toolbar a:hover {
        opacity: 1;
        background-color: var(--primary-dark) !important;
    }
    
    #infoPanel {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--bg-card);
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid var(--border);
        z-index: 15;
        box-shadow: var(--shadow);
        color: var(--text-secondary);
        font-size: 14px;
        min-width: 250px;
        text-align: center;
        bottom: 50px; 
    }
    .hidden { display: none; }

    /* ЗМІНА 1: Кнопка Map Help зроблена більш помітною та переміщена у лівий нижній кут */
    #helpButton {
        position: absolute;
        bottom: 10px; 
        left: 10px; /* Переміщено в лівий нижній кут */
        z-index: 20; /* Вищий Z-index */
        padding: 12px 22px; /* Більший розмір */
        /* Яскравий, контрастний градієнт */
        background: linear-gradient(90deg, #ff9900, #ff6600); 
        color: white; 
        border: 2px solid #ffaa00; 
        border-radius: 10px;
        font-size: 16px; 
        font-weight: 800; 
        cursor: pointer;
        transition: var(--transition);
        /* Інтенсивніша тінь */
        box-shadow: 0 6px 20px rgba(255, 102, 0, 0.6); 
    }
    #helpButton:hover {
        background: linear-gradient(90deg, #ff6600, #ff9900);
        box-shadow: 0 8px 25px rgba(255, 102, 0, 0.8);
        transform: translateY(-2px);
    }
    
    /* ЗМІНА 2: Переміщення Map Controls у правий нижній кут, щоб не перекривати кнопку Help */
    #mapControls {
      position: absolute;
      bottom: 10px; 
      right: 10px; /* Переміщено в правий нижній кут */
      left: auto; /* Скасовує попередню властивість left */
      z-index: 15;
      background: var(--bg-card);
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column; 
      gap: 8px;
    }
    #mapControls > div {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 14px;
    }
    #mapControls input[type=date] {
        padding: 5px;
        border-radius: 4px;
        border: 1px solid var(--border);
        background: var(--bg-dark);
        color: var(--text-primary);
        font-family: inherit;
        font-size: 14px;
    }
    #mapControls .range-value-inline {
        margin-left: 8px;
        font-weight: 600;
        color: var(--secondary);
    }
    #mapControls label {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    #mapControls input[type=range] {
        width: 100px;
    }


    /* Стилі для модального вікна допомоги */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s, opacity 0.3s;
    }
    .modal-overlay.active {
        visibility: visible;
        opacity: 1;
    }
    .modal-content {
        background: var(--bg-dark);
        border-radius: var(--radius);
        padding: 30px;
        width: 90%;
        max-width: 600px;
        box-shadow: var(--shadow);
        border: 2px solid var(--primary);
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-content h3 {
        color: var(--primary);
        font-size: 24px;
        margin-top: 0;
    }
    .modal-content ol {
        list-style-type: decimal;
        padding-left: 20px;
        margin-top: 15px;
    }
    .modal-content li {
        margin-bottom: 15px;
        font-size: 15px;
        color: var(--text-secondary);
    }
    .modal-content li strong {
        color: var(--text-primary);
    }
    .modal-close {
        float: right;
        font-size: 24px;
        font-weight: 600;
        cursor: pointer;
        color: var(--text-secondary);
        transition: color 0.2s;
    }
    .modal-close:hover {
        color: var(--danger);
    }

    @media (max-width: 1100px) {
        .container {
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
            gap: 8px;
            padding: 8px;
            height: auto;
        }
        
        .sidebar {
            order: 2;
            height: auto;
            max-height: 50vh;
        }
        
        .data-grid {
            grid-template-columns: 1fr;
            gap: 0;
        }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="container">
      
      <div class="card sidebar">
        <div class="header-container">
          <div>
            <h1 class="app-title">AgroOrbiField</h1>
            <div class="app-subtitle">Farm Navigators — GIS Mission</div>
          </div>
          <a href="quiz.html" class="btn btn-ghost" style="
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--secondary), var(--secondary-light));
            color: var(--bg-dark);
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            border: none;
            box-shadow: 0 4px 15px rgba(203, 226, 43, 0.3);
            transition: all 0.3s ease;
            white-space: nowrap;
            margin-left: 15px;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(203, 226, 43, 0.5)'" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(203, 226, 43, 0.3)'">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M11 18H13V16H11V18ZM12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM12 6C9.79 6 8 7.79 8 10H10C10 8.9 10.9 8 12 8C13.1 8 14 8.9 14 10C14 11.5 12 12.25 12 15H14C14 12.75 16 12 16 10C16 7.79 14.21 6 12 6Z" fill="currentColor"/>
            </svg>
            Interactive Quiz
          </a>
        </div>
        
        <div class="data-panel">
            <div class="data-summary-title">Selected Field and Centroid</div>
            <div id="coords" class="coords">Draw a field on the map</div>
            <div id="dataSummary" class="data-summary-content">
                Select an area on the map to get meteorological data from the NASA POWER API and run a simulation.
            </div>
        </div>

        <div class="form-group">
          <label for="cropSelect">Planning: Select Crop</label>
          <select id="cropSelect">
            <option value="maize">Maize</option>
            <option value="wheat">Wheat</option>
            <option value="soy">Soy</option>
            <option value="sorghum">Sorghum (Сорго)</option>
            
            <option value="barley">Barley</option>
            <option value="sunflower">Sunflower</option>
            <option value="sugarbeet">Sugar Beet</option>
            <option value="rapeseed">Rapeseed</option>
            <option value="rice">Rice</option>
            <option value="potato">Potato</option>
          </select>
        </div>

        <div class="form-group">
          <label for="irrigation">Planning: Irrigation (mm / day)</label>
          <input id="irrigation" type="range" min="0" max="10" step="0.5" value="3">
          <div class="range-value">
            <span>Irrigation Intensity</span>
            <span id="irrigationOut">3.0</span>
          </div>
        </div>

        <div class="form-group">
          <label for="fert">Planning: Fertilizer (kg / ha)</label>
          <input id="fert" type="range" min="0" max="200" step="10" value="80">
          <div class="range-value">
            <span>Fertilizer Applied (N)</span>
            <span id="fertOut">80</span>
          </div>
        </div>

        <div class="btn-group">
          <button id="runSim" class="btn" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
            </svg>
            Run Simulation (1 Year)
          </button>
          <button class="btn btn-ghost" id="reset">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4.01 7.58 4.01 12C4.01 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z" fill="currentColor"/>
            </svg>
            Reset
          </button>
        </div>
        
        <div>
          <a href="game.html" class="game-button-footer" title="Game feature is under development">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
            </svg>
            START GAME (MVP)
          </a>
        </div>
      </div>

      <div style="display: flex; flex-direction: column; height: 100%; width: 100%;">
        <div style="flex: 1; position: relative; min-height: 300px;"> 
          <div id="map" style="height: 100%; width: 100%;"></div>
          
          <div id="mapControls">
            <div>
              <strong>Layer Date:</strong> 
              <input id="datePicker" type="date"/>
            </div>
            <div>
              <label for="opacity">Opacity:</label>
              <input id="opacity" type="range" min="0" max="1" step="0.01" value="0.7" style="width: 100px;"/>
              <span id="opacityVal" class="range-value-inline">70%</span>
            </div>
          </div>
          <div id="infoPanel" class="hidden"></div>
          
          <button id="helpButton">Map Help</button>

          <div id="errors"></div>
        </div>
        
        <div class="data-grid" style="padding-top: 8px;"> 
          <div class="card" style="border-bottom: 1px solid var(--border);">
            <div class="card-header">
              <h3 class="card-title">Weather Forecast / NASA POWER Data</h3>
              <div class="card-subtitle">Meteorological data retrieved for the field centroid.</div>
            </div>
            <div id="powerDataSummary" style="margin-top: 15px;">Draw a field to see data.</div>
          </div>

          <div class="card" style="border-left: 1px solid var(--border);">
            <div class="card-header">
              <h3 class="card-title">Season Summary</h3><div class="card-subtitle">Sustainability and Efficiency Assessment</div>

            </div>
            <div class="results-grid">
              <div class="result-item">
                <div class="result-label">Yield (kg/ha)</div>
                <div class="result-value" id="yieldVal">—</div>
              </div>
              <div class="result-item">
                <div class="result-label">Water Usage (m³)</div>
                <div class="result-value" id="waterVal">—</div>
              </div>
              <div class="result-item">
                <div class="result-label">Emissions / Ecology</div>
                <div class="result-value" id="ecoVal">—</div>
              </div>
              <div class="result-item">
                <div class="result-label">Score</div>
                <div class="result-value score" id="scoreVal">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer>Prototype — uses NASA POWER API. Other services will be used in the full version.</footer>
  </div>

  <div id="helpModal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <h3>How to Use AgroOrbiField (GIS Tools)</h3>
      <p>To run the simulation, you need to draw the boundaries of your agricultural field on the map using the Leaflet Draw tools.</p>
      <ol>
          <li>
              <strong>Select the Tool:</strong> In the map toolbar (usually top left), click the polygon icon (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM17 17H7V7H17V17ZM12 4.5L14.5 9.5H9.5L12 4.5Z" fill="currentColor"/></svg>).
          </li>
          <li>
              <strong>Draw the Field:</strong> Click on the map to set the corners of your field. To complete the polygon, click on the starting point.
          </li>
          <li>
              <strong>Get Data:</strong> After drawing is complete, the Area of the field will appear, and the centroid middle point) coordinates will update in the sidebar. The system will automatically check the surface type and start loading NASA POWER meteorological data for this point.
          </li>
          <li>
              <strong>Editing:</strong> If you need to change the shape, click the edit icon (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25ZM20.71 7.04C21.1 6.65 21.1 6.02 20.71 5.63L18.37 3.29C17.98 2.9 17.35 2.9 16.96 3.29L15.13 5.12L18.88 8.87L20.71 7.04Z" fill="currentColor"/></svg>) on the toolbar.
          </li>
          <li>
              <strong>Layer Management:</strong> You can turn map layers on/off (NDVI, Surface Temperature, etc.) and manage their date and opacity using the controls in the bottom right corner of the map. You can also collapse the layer list by clicking the small "▲" button in the layers window.
          </li>
          <li>
              <strong>Run Simulation:</strong> Once the field is drawn, NASA POWER data is loaded, and you set the parameters (Crop, Irrigation, Fertilizer), the "Run Simulation" button will become active.
          </li>
      </ol>
  </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js" crossorigin=""></script>
  
  <script>
    // --- GLOBAL VARIABLES ---
    let map;
    let drawnItems;
    let drawnLayer = null;
    let geoData = null;
    let nasaPowerData = null;
    
    const errorsEl = document.getElementById('errors');
    const runSimBtn = document.getElementById('runSim');
    const coordsEl = document.getElementById('coords');
    const powerDataSummaryEl = document.getElementById('powerDataSummary');
    const infoPanel = document.getElementById('infoPanel');
    
    // --- LAYER CONSTANTS ---
    const LAYER_TRUECOLOR = 'MODIS_Terra_CorrectedReflectance_TrueColor';
    const LAYER_LST_DAY   = 'MODIS_Terra_Land_Surface_Temp_Day';
    const NDVI_IMAGE_URL = 'https://gis.nnvl.noaa.gov/arcgis/rest/services/NDVI/NDVI_weekly/ImageServer';
    
    let gibsDate;
    let ndviMaxDate = null;
    let swi; 

    // --- CROP PARAMETERS FOR SIMULATION ---
    const cropParameters = {
      maize: { baseYield: 15000, optTemp: { min: 18, max: 32 }, waterNeed: 600, growingSeason: [4, 5, 6, 7, 8, 9] }, // April-Sept
      wheat: { baseYield: 10000, optTemp: { min: 15, max: 25 }, waterNeed: 500, growingSeason: [3, 4, 5, 6, 7] }, // March-July
      soy: { baseYield: 6000, optTemp: { min: 20, max: 30 }, waterNeed: 550, growingSeason: [5, 6, 7, 8, 9] }, // May-Sept
      // Default fallback
      default: { baseYield: 8000, optTemp: { min: 15, max: 30 }, waterNeed: 500, growingSeason: [4, 5, 6, 7, 8] }
    };

    // ВИДАЛЕНО: Функцію log

    function showError(msg) {
      console.error(msg);
      errorsEl.textContent = msg;
      errorsEl.style.display = 'block';
      setTimeout(() => {
        errorsEl.style.display = 'none';
      }, 5000);
    }
    
    function displaySimulationResults(results) {
      document.getElementById('yieldVal').textContent = `${results.yield} kg/ha`;
      document.getElementById('waterVal').textContent = `${results.water} m³`;
      document.getElementById('ecoVal').textContent = results.eco;
      document.getElementById('scoreVal').textContent = results.score;
      // ВИДАЛЕНО: log('Simulation successfully completed. Results updated.');
    }

    const pad = n => String(n).padStart(2,'0');
    const toDateStr = d => `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}`;

    function updateIrrigationValue(e) {
      document.getElementById('irrigationOut').textContent = e.target.value;
    }

    function updateFertilizerValue(e) {
      document.getElementById('fertOut').textContent = e.target.value;
    }
    
    function resetForm() {
      document.getElementById('irrigation').value = 3;
      document.getElementById('irrigationOut').textContent = '3.0';
      document.getElementById('fert').value = 80;
      document.getElementById('fertOut').textContent = '80';
      document.getElementById('cropSelect').value = 'maize';
      
      coordsEl.textContent = 'Draw a field on the map';
      powerDataSummaryEl.innerHTML = 'Draw a field to see data.';
      document.getElementById('yieldVal').textContent = '—';
      document.getElementById('waterVal').textContent = '—';
      document.getElementById('ecoVal').textContent = '—';
      document.getElementById('scoreVal').textContent = '—';
      infoPanel.classList.add('hidden');
      infoPanel.innerHTML = '';
      
      geoData = null;
      nasaPowerData = null;
      runSimBtn.disabled = true;
      if (drawnLayer) { drawnItems.removeLayer(drawnLayer); drawnLayer = null; }
      
      const today = new Date();
      document.getElementById('datePicker').value = toDateStr(today);
      gibsDate = toDateStr(today);
      setAllDates(gibsDate);
      // ВИДАЛЕНО: log('Parameters reset to initial values');
    }
    
    // --- LAYER LOGIC (Unchanged) ---
    function gibsLayer(layerId, dateStr, options = {}) {
      const fmt = options.format || 'jpg'; const tms = options.tms || 'GoogleMapsCompatible_Level9';
      const opacity = options.opacity ?? 0.7; const subdomains = options.subdomains || ['a','b','c'];
      const url = `https://gibs-{s}.earthdata.nasa.gov/wmts/epsg3857/best/${layerId}/default/${dateStr}/${tms}/{z}/{y}/{x}.${fmt}`;
      return L.tileLayer(url, { subdomains, opacity, crossOrigin: true, maxNativeZoom: 8 });
    }
    function setAllDates(dateStr) {
      trueColor.setUrl(`https://gibs-{s}.earthdata.nasa.gov/wmts/epsg3857/best/${LAYER_TRUECOLOR}/default/${dateStr}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`);
      lstDay.setUrl   (`https://gibs-{s}.earthdata.nasa.gov/wmts/epsg3857/best/${LAYER_LST_DAY  }/default/${dateStr}/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png`);
      const from = new Date(dateStr); const to = new Date(dateStr);
      if (ndvi.setTimeRange) ndvi.setTimeRange(from, to); 
    }
    function clampDateToNDVIRange() {
      if (!ndviMaxDate) return;
      const pick = document.getElementById('datePicker').value;
      if (pick > ndviMaxDate) { document.getElementById('datePicker').value = ndviMaxDate; }
      gibsDate = document.getElementById('datePicker').value;
      setAllDates(gibsDate);
    }
    function setOverlayOpacity(v) {
      const val = parseFloat(v);
      ndvi.setOpacity(val);
      if (swi && swi.setOpacity) { swi.setOpacity(val); }
      lstDay.setOpacity(val);
      document.getElementById('opacityVal').textContent = Math.round(val * 100) + '%';
    }

    // --- MAP AND GIS LOGIC ---
    let osm, esriSat, ndvi, trueColor, lstDay;
    function initializeMap() {
      const today = new Date();
      document.getElementById('datePicker').value = toDateStr(today);
      gibsDate = toDateStr(today);
      map = L.map('map', { minZoom: 2, worldCopyJump: false, maxBounds: [[-85, -180], [85, 180]], maxBoundsViscosity: 1.0 }).setView([48.3794, 31.1656], 4);
      osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OSM' });
      esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Esri' }).addTo(map);
      ndvi = L.esri.imageMapLayer({ url: NDVI_IMAGE_URL, opacity: 0.7, attribution: 'NOAA', format: 'png32', transparent: true }).addTo(map);
      trueColor = gibsLayer(LAYER_TRUECOLOR, gibsDate, { format: 'jpg', opacity: 1.0 });
      lstDay    = gibsLayer(LAYER_LST_DAY,   gibsDate, { format: 'png', opacity: 0.7 });
      const baseLayers = { 'Satellite (Esri)': esriSat, 'Street (OSM)': osm, 'Satellite (NASA)': trueColor };
      const overlayLayers = { 'Vegetation (NDVI)': ndvi, 'Surface Temp (LST)': lstDay };
      
      const layerControl = L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);

      // Додавання кнопки згортання/розгортання шарів
      const layerControlContainer = layerControl.getContainer();
      const listElement = layerControlContainer.querySelector('.leaflet-control-layers-list');
      const button = document.createElement('button');
      button.id = 'toggleLayersButton';
      button.innerHTML = '▲'; 
      layerControlContainer.prepend(button);
      
      button.addEventListener('click', (e) => {
        e.stopPropagation(); 
        const isHidden = listElement.classList.toggle('hidden');
        button.innerHTML = isHidden ? '▼' : '▲';
      });

      fetch(NDVI_IMAGE_URL + '?f=json').then(r => r.json()).then(info => { if (info?.timeInfo?.timeExtent) { const endMs = info.timeInfo.timeExtent[1]; if (endMs) { ndviMaxDate = toDateStr(new Date(endMs)); clampDateToNDVIRange(); } } }).catch(() => {});
      setOverlayOpacity(document.getElementById('opacity').value);
      drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);
      const drawControl = new L.Control.Draw({ edit: { featureGroup: drawnItems }, draw: { polygon: { shapeOptions: { color: '#cbe22b' }, showArea: true }, polyline: false, circle: false, rectangle: false, marker: false, circlemarker: false } });
      map.addControl(drawControl);
      map.on(L.Draw.Event.CREATED, (e) => { if (drawnLayer) drawnItems.removeLayer(drawnLayer); drawnLayer = e.layer; drawnItems.addLayer(drawnLayer); updateUIState(); });
      map.on(L.Draw.Event.EDITED, (e) => { e.layers.eachLayer((layer) => { drawnLayer = layer; }); updateUIState(); });
      map.on(L.Draw.Event.DELETED, () => { drawnLayer = null; updateUIState(); });
      // ВИДАЛЕНО: log('System ready. Please draw a field on land to begin.');
    }
    
    function updateUIState() {
        if (!drawnLayer) {
            geoData = null; nasaPowerData = null; runSimBtn.disabled = true;
            coordsEl.textContent = 'Draw a field on the map';
            powerDataSummaryEl.innerHTML = 'Draw a field to see data.';
            infoPanel.classList.add('hidden');
            // ВИДАЛЕНО: log('Field deleted. Please draw a new one.');
            return;
        }
        try {
            const polygon = drawnLayer.toGeoJSON();
            const centroid = turf.centroid(polygon);
            const lat = centroid.geometry.coordinates[1].toFixed(4);
            const lon = centroid.geometry.coordinates[0].toFixed(4);
            geoData = { lat, lon };
            const areaHa = (turf.area(polygon) / 10000).toFixed(2);
            coordsEl.innerHTML = `<strong>Centroid:</strong> Lat: ${lat}, Lon: ${lon}`;
            infoPanel.innerHTML = `<strong>Area:</strong> ${areaHa} ha`;
            infoPanel.classList.remove('hidden');
            // ВИДАЛЕНО: log(`Field updated. Area: ${areaHa} ha. Starting data checks...`);
            checkSurfaceAndGetData(lat, lon);
        } catch(e) {
            showError(`GIS Error: ${e.message}`);
            runSimBtn.disabled = true; geoData = null;
        }
    }

    function setupEventListeners() {
      document.getElementById('irrigation').addEventListener('input', updateIrrigationValue);
      document.getElementById('fert').addEventListener('input', updateFertilizerValue);
      document.getElementById('runSim').addEventListener('click', runSimulation);
      document.getElementById('reset').addEventListener('click', resetForm);
      document.getElementById('datePicker').addEventListener('change', () => { gibsDate = this.value; clampDateToNDVIRange(); });
      document.getElementById('opacity').addEventListener('input', (e) => setOverlayOpacity(e.target.value));
      const helpModal = document.getElementById('helpModal');
      document.getElementById('helpButton').addEventListener('click', () => { helpModal.classList.add('active'); });
      document.querySelector('.modal-close').addEventListener('click', () => { helpModal.classList.remove('active'); });
      helpModal.addEventListener('click', (e) => { if (e.target.id === 'helpModal') { helpModal.classList.remove('active'); } });
      updateIrrigationValue({target: document.getElementById('irrigation')});
      updateFertilizerValue({target: document.getElementById('fert')});
    }

    async function checkSurfaceAndGetData(lat, lon) {
      runSimBtn.disabled = true;
      powerDataSummaryEl.innerHTML = 'Checking surface type...';
      try {
        const url = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
        const data = await response.json();

        const locality = data.locality || '';
        const isWater = locality.includes('Ocean') || locality.includes('Sea') || locality.includes('Gulf') || locality.includes('Bay') || !data.principalSubdivision;

        if (isWater) {
          showError("Simulation is not possible. The selected area is in water.");
          // ВИДАЛЕНО: log(`Check failed: selected area is water (${locality}).`);
          powerDataSummaryEl.innerHTML = '<span style="color: var(--danger);">Area is in water. Please select a land area.</span>';
          nasaPowerData = null;
        } else {
          // ВИДАЛЕНО: log(`Surface check successful: It's land (${data.principalSubdivision}).`);
          await fetchNasaPowerData(lat, lon);
        }
      } catch (e) {
        showError("Could not verify surface type. Please try again.");
        console.error("BigDataCloud API error:", e);
        powerDataSummaryEl.innerHTML = 'Could not verify surface type.';
        nasaPowerData = null;
      }
    }
    
    async function fetchNasaPowerData(lat, lon) {
      powerDataSummaryEl.innerHTML = 'Loading real data from NASA POWER...';
      const year = new Date().getFullYear() - 1;
      const parameters = "T2M_MAX,T2M_MIN,PRECTOTCORR,ALLSKY_SFC_SW_DWN";
      const url = `https://power.larc.nasa.gov/api/temporal/monthly/point?parameters=${parameters}&community=AG&longitude=${lon}&latitude=${lat}&start=${year}&end=${year}&format=JSON`;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`API responded with status ${response.status}`);
        const data = await response.json();
        nasaPowerData = data.properties.parameter;
        
        const avgTemp = Object.values(nasaPowerData.T2M_MIN).reduce((sum, val, i) => sum + (val + Object.values(nasaPowerData.T2M_MAX)[i]) / 2, 0) / 12;
        const totalPrecip = Object.values(nasaPowerData.PRECTOTCORR).reduce((sum, val) => sum + val, 0); // Total mm/year
        const avgRadiation = Object.values(nasaPowerData.ALLSKY_SFC_SW_DWN).reduce((sum, val) => sum + val, 0) / 12;

        powerDataSummaryEl.innerHTML = `
          <ul style="list-style: none; padding: 0;">
            <li style="margin-bottom: 5px;"><strong>Annual Avg T°:</strong> ${avgTemp.toFixed(1)} °C</li>
            <li style="margin-bottom: 5px;"><strong>Total Annual Precip:</strong> ${totalPrecip.toFixed(0)} mm</li>
            <li><strong>Avg Daily Solar Rad:</strong> ${avgRadiation.toFixed(1)} kW-hr/m²/day</li>
          </ul>`;
        // ВИДАЛЕНО: log(`NASA POWER data for ${year} received.`);
        runSimBtn.disabled = false;
      } catch (e) {
          showError(`Failed to get data from NASA POWER. ${e.message}`);
          powerDataSummaryEl.innerHTML = '<span style="color: var(--danger);">Error loading NASA data.</span>';
          nasaPowerData = null;
      }
    }
    
    function runSimulation() {
      if (!geoData || !nasaPowerData) {
        showError('Please draw a field on land and wait for NASA data to load.');
        return;
      }

      runSimBtn.disabled = true;
      runSimBtn.innerHTML = 'Calculating...'; 
      // ВИДАЛЕНО: log('Simulation started with real data...');

      const cropId = document.getElementById('cropSelect').value;
      const irrigation = parseFloat(document.getElementById('irrigation').value);
      const fertilizer = parseFloat(document.getElementById('fert').value);
      
      const params = cropParameters[cropId] || cropParameters.default;
      const year = new Date().getFullYear() - 1;

      // 1. Temperature Factor
      let tempPenalty = 0;
      params.growingSeason.forEach(monthIndex => {
        const monthKey = `${year}${String(monthIndex).padStart(2, '0')}`;
        const avgT = (nasaPowerData.T2M_MIN[monthKey] + nasaPowerData.T2M_MAX[monthKey]) / 2;
        if (avgT < params.optTemp.min) tempPenalty += (params.optTemp.min - avgT) * 0.05;
        if (avgT > params.optTemp.max) tempPenalty += (avgT - params.optTemp.max) * 0.05;
      });
      const tempFactor = Math.max(0.1, 1 - (tempPenalty / params.growingSeason.length));

      // 2. Water Factor
      let totalPrecip = 0;
      params.growingSeason.forEach(monthIndex => {
        const monthKey = `${year}${String(monthIndex).padStart(2, '0')}`;
        totalPrecip += nasaPowerData.PRECTOTCORR[monthKey];
      });
      const totalIrrigation = irrigation * 30.4 * params.growingSeason.length;
      const waterFactor = Math.min(1.2, (totalPrecip + totalIrrigation) / params.waterNeed);

      // 3. Fertilizer Factor
      let fertFactor = 0.5 + (1.2 - 0.5) * (1 - Math.exp(-0.025 * fertilizer));
      if (fertilizer > 180) fertFactor *= 0.9;

      const limitingFactor = Math.min(tempFactor, waterFactor);
      const finalYield = params.baseYield * limitingFactor * fertFactor;

      let eco = 'High';
      let score = 80;
      if (fertilizer > 150) { eco = 'Low (Fertilizer Overdose)'; score -= 20; }
      if (irrigation > 8) { eco = 'Fair (High Water Use)'; score -= 10; }
      if (limitingFactor < 0.7) score -= 15;
      score *= (0.5 + limitingFactor / 2);

      setTimeout(() => {
          const results = {
              yield: finalYield.toFixed(0),
              water: ((totalIrrigation / 1000) * 10000).toFixed(0),
              eco: eco,
              score: Math.min(99, Math.max(30, score)).toFixed(0) + '/100'
          };
          displaySimulationResults(results);
          runSimBtn.disabled = false;
          runSimBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24"><path d="M8 5V19L19 12L8 5Z" fill="currentColor"/></svg> Run Simulation (1 Year)';
      }, 1500);
    }
    
    // --- INITIALIZATION ---
    window.onload = function() {
      initializeMap();
      setupEventListeners();
    }
  </script>
</body>
</html>